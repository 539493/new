<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        video {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .start { background: #4CAF50; color: white; }
        .stop { background: #f44336; color: white; }
        .mute { background: #ff9800; color: white; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebRTC Video Chat Test</h1>
        
        <div class="status" id="status">Отключено</div>
        
        <div class="video-container">
            <div>
                <h3>Локальное видео</h3>
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            <div>
                <h3>Удаленное видео</h3>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>
        
        <div class="controls">
            <button class="start" onclick="startVideo()">Начать видео</button>
            <button class="stop" onclick="stopVideo()">Остановить</button>
            <button class="mute" onclick="toggleMute()">Включить/Выключить звук</button>
        </div>
        
        <div>
            <h3>Логи:</h3>
            <div id="logs" style="background: #f8f9fa; padding: 10px; border-radius: 4px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let localStream = null;
        let peerConnection = null;
        let socket = null;
        let isMuted = false;

        function log(message) {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `[${time}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function updateStatus(message, isConnected = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
        }

        async function startVideo() {
            try {
                log('Запрашиваем доступ к камере и микрофону...');
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                await localVideo.play();

                log('Доступ к камере получен');
                updateStatus('Камера активна', true);

                // Подключаемся к серверу
                connectToServer();

            } catch (error) {
                log(`Ошибка получения доступа к камере: ${error.message}`);
                updateStatus('Ошибка доступа к камере');
            }
        }

        function connectToServer() {
            const socketUrl = window.location.hostname === 'localhost' ? 'http://localhost:3001' : window.location.origin;
            socket = io(socketUrl);

            socket.on('connect', () => {
                log('Подключено к серверу');
                socket.emit('video-join', {
                    roomId: 'test-room',
                    userName: 'Test User',
                    userRole: 'test'
                });
            });

            socket.on('connect_error', (error) => {
                log(`Ошибка подключения к серверу: ${error.message}`);
            });

            socket.on('video-connected', (data) => {
                log(`Подключено к видео комнате: ${data.roomId}`);
                createPeerConnection();
            });

            socket.on('video-user-joined', (data) => {
                log(`Пользователь присоединился: ${data.userName}`);
                if (peerConnection) {
                    createOffer();
                }
            });

            socket.on('video-offer', async (data) => {
                log('Получен offer');
                if (peerConnection) {
                    try {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        socket.emit('video-answer', {
                            roomId: 'test-room',
                            answer
                        });
                    } catch (error) {
                        log(`Ошибка обработки offer: ${error.message}`);
                    }
                }
            });

            socket.on('video-answer', async (data) => {
                log('Получен answer');
                if (peerConnection) {
                    try {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    } catch (error) {
                        log(`Ошибка обработки answer: ${error.message}`);
                    }
                }
            });

            socket.on('video-ice-candidate', async (data) => {
                log('Получен ICE candidate');
                if (peerConnection) {
                    try {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                    } catch (error) {
                        log(`Ошибка добавления ICE candidate: ${error.message}`);
                    }
                }
            });
        }

        function createPeerConnection() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ],
                iceCandidatePoolSize: 10
            };

            peerConnection = new RTCPeerConnection(configuration);

            // Добавляем локальный поток
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Обрабатываем входящие потоки
            peerConnection.ontrack = (event) => {
                log('Получен удаленный поток');
                const remoteVideo = document.getElementById('remoteVideo');
                remoteVideo.srcObject = event.streams[0];
                remoteVideo.play().catch(console.error);
            };

            // Обрабатываем ICE кандидаты
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('video-ice-candidate', {
                        roomId: 'test-room',
                        candidate: event.candidate
                    });
                }
            };

            // Обрабатываем изменения состояния соединения
            peerConnection.onconnectionstatechange = () => {
                log(`Состояние соединения: ${peerConnection.connectionState}`);
            };

            peerConnection.oniceconnectionstatechange = () => {
                log(`Состояние ICE соединения: ${peerConnection.iceConnectionState}`);
            };

            log('PeerConnection создан');
        }

        async function createOffer() {
            if (peerConnection) {
                try {
                    const offer = await peerConnection.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });
                    await peerConnection.setLocalDescription(offer);
                    socket.emit('video-offer', {
                        roomId: 'test-room',
                        offer
                    });
                    log('Offer отправлен');
                } catch (error) {
                    log(`Ошибка создания offer: ${error.message}`);
                }
            }
        }

        function stopVideo() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            
            log('Видео остановлено');
            updateStatus('Отключено');
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isMuted = !audioTrack.enabled;
                    log(`Звук ${isMuted ? 'выключен' : 'включен'}`);
                }
            }
        }

        // Инициализация
        log('WebRTC тест готов');
    </script>
</body>
</html> 