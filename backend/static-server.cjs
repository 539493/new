const express = require('express');
const path = require('path');
const { Server } = require('socket.io');
const http = require('http');
const cors = require('cors');

const app = express();
const server = http.createServer(app);

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° CORS
const allowedOrigins = [
  "http://localhost:3000",
  "http://localhost:3001", 
  "http://localhost:3002",
  "http://localhost:4173",
  "https://*.vercel.app",
  "https://*.onrender.com",
  "https://tutoring-platform.vercel.app",
  "https://tutoring-platform.onrender.com",
  "https://tutoring-platform-*.onrender.com"
];

app.use(cors({
  origin: function (origin, callback) {
    if (!origin) return callback(null, true);
    
    const isAllowed = allowedOrigins.some(allowedOrigin => {
      if (allowedOrigin.includes('*')) {
        const pattern = allowedOrigin.replace('*', '.*');
        return new RegExp(pattern).test(origin);
      }
      return allowedOrigin === origin;
    });
    
    if (isAllowed) {
      callback(null, true);
    } else {
      console.log('Blocked origin:', origin);
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
}));

// Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Socket.IO ÑÐµÑ€Ð²ÐµÑ€Ð°
const io = new Server(server, {
  cors: {
    origin: function (origin, callback) {
      if (!origin) return callback(null, true);
      
      const isAllowed = allowedOrigins.some(allowedOrigin => {
        if (allowedOrigin.includes('*')) {
          const pattern = allowedOrigin.replace('*', '.*');
          return new RegExp(pattern).test(origin);
        }
        return allowedOrigin === origin;
      });
      
      if (isAllowed) {
        callback(null, true);
      } else {
        console.log('Socket.IO blocked origin:', origin);
        callback(new Error('Not allowed by CORS'));
      }
    },
    credentials: true,
    methods: ["GET", "POST"]
  }
});

// Ð Ð°Ð·Ð´Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Ð¿Ð°Ð¿ÐºÐ¸ dist
app.use(express.static(path.join(__dirname, '../dist')));

// API Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹
app.get('/api/health', (req, res) => {
  res.json({ 
    message: 'Tutoring Platform WebSocket Server',
    status: 'running',
    connectedClients: io.engine.clientsCount,
    timeSlots: 0,
    lessons: 0,
    timestamp: new Date().toISOString(),
    environment: process.env.NODE_ENV || 'production'
  });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²ÑÐµÑ… Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¾Ð² - Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ index.html Ð´Ð»Ñ SPA
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, '../dist/index.html'));
});

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
const fs = require('fs');
const DATA_FILE = path.join(__dirname, 'server_data.json');

function loadServerData() {
  try {
    if (fs.existsSync(DATA_FILE)) {
      const data = JSON.parse(fs.readFileSync(DATA_FILE, 'utf8'));
      console.log('Loaded server data from file');
      return data;
    }
  } catch (error) {
    console.error('Error loading server data:', error);
  }
  return {
    teacherProfiles: {},
    studentProfiles: {},
    overbookingRequests: [],
    timeSlots: [],
    lessons: [],
    chats: []
  };
}

function saveServerData() {
  try {
    const data = {
      teacherProfiles,
      studentProfiles,
      overbookingRequests,
      timeSlots,
      lessons,
      chats
    };
    console.log('=== SAVING SERVER DATA ===');
    console.log('Data file path:', DATA_FILE);
    console.log('Teacher profiles count:', Object.keys(teacherProfiles).length);
    console.log('Student profiles count:', Object.keys(studentProfiles).length);
    console.log('Overbooking requests count:', overbookingRequests.length);
    console.log('Time slots count:', timeSlots.length);
    console.log('Lessons count:', lessons.length);
    console.log('Chats count:', chats.length);
    
    fs.writeFileSync(DATA_FILE, JSON.stringify(data, null, 2));
    console.log('Server data saved to file successfully');
    console.log('=== SAVE COMPLETED ===');
  } catch (error) {
    console.error('Error saving server data:', error);
  }
}

// Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ ÑÐµÑ€Ð²ÐµÑ€Ð°
const serverData = loadServerData();

// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
let teacherProfiles = serverData.teacherProfiles && typeof serverData.teacherProfiles === 'object' ? serverData.teacherProfiles : {};
let studentProfiles = serverData.studentProfiles && typeof serverData.studentProfiles === 'object' ? serverData.studentProfiles : {};
let timeSlots = Array.isArray(serverData.timeSlots) ? serverData.timeSlots : [];
let lessons = Array.isArray(serverData.lessons) ? serverData.lessons : [];
let chats = Array.isArray(serverData.chats) ? serverData.chats : [];
let overbookingRequests = Array.isArray(serverData.overbookingRequests) ? serverData.overbookingRequests : [];

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÑÐ»Ð¾Ñ‚Ð¾Ð² (ÑÑ‚Ð°Ñ€ÑˆÐµ 30 Ð´Ð½ÐµÐ¹)
function cleanupOldSlots() {
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  const oldSlots = timeSlots.filter(slot => {
    const slotDate = new Date(slot.date);
    return slotDate < thirtyDaysAgo;
  });
  
  if (oldSlots.length > 0) {
    timeSlots = timeSlots.filter(slot => {
      const slotDate = new Date(slot.date);
      return slotDate >= thirtyDaysAgo;
    });
    
    console.log(`Cleaned up ${oldSlots.length} old slots`);
    saveServerData();
  }
}

// ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÑÐ»Ð¾Ñ‚Ñ‹ Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ ÑÐµÑ€Ð²ÐµÑ€Ð°
cleanupOldSlots();

// WebSocket Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸
io.on('connection', (socket) => {
  console.log('=== CLIENT CONNECTED ===');
  console.log('Socket ID:', socket.id);
  console.log('Total connected clients:', io.engine.clientsCount);
  
  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð¾Ð²Ð¾Ð¼Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ
  console.log('Sending initial data to client:', {
    timeSlotsCount: timeSlots.length,
    lessonsCount: lessons.length,
    chatsCount: chats.length,
    teacherProfilesCount: Object.keys(teacherProfiles).length
  });
  socket.emit('initialData', { timeSlots, lessons, chats });

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ¾Ð² Ð½Ð¾Ð²Ð¾Ð¼Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ
  socket.emit('studentProfiles', studentProfiles);
  
  // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ ÑÐ»Ð¾Ñ‚Ñ‹ Ð´Ð»Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸
  socket.emit('allSlots', timeSlots);
  
  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð²ÑÐµÑ… ÑÐ»Ð¾Ñ‚Ð¾Ð²
  socket.on('requestAllSlots', () => {
    console.log('Client requested all slots');
    socket.emit('allSlots', timeSlots);
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»Ð¾Ñ‚Ð°
  socket.on('createSlot', (newSlot) => {
    console.log('=== NEW SLOT CREATED ===');
    console.log('Slot data:', newSlot);
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ ÑƒÐ¶Ðµ ÑÐ»Ð¾Ñ‚ Ñ Ñ‚Ð°ÐºÐ¸Ð¼ ID
    const existingSlotIndex = timeSlots.findIndex(slot => slot.id === newSlot.id);
    if (existingSlotIndex !== -1) {
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÑÐ»Ð¾Ñ‚
      timeSlots[existingSlotIndex] = { ...timeSlots[existingSlotIndex], ...newSlot };
      console.log('Updated existing slot:', newSlot.id);
    } else {
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÑÐ»Ð¾Ñ‚
      timeSlots.push(newSlot);
      console.log('Added new slot:', newSlot.id);
    }
    
    console.log('Total slots on server:', timeSlots.length);
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ñ„Ð°Ð¹Ð»
    saveServerData();
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÑÐ»Ð¾Ñ‚ Ð²ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ñ‹Ð¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼
    io.emit('slotCreated', newSlot);
    console.log('Slot broadcasted to all clients');
    console.log('=== SLOT CREATION COMPLETED ===');
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐ»Ð¾Ñ‚Ð°
  socket.on('bookSlot', (data) => {
    console.log('Slot booked:', data);
    const { slotId, lesson } = data;
    
    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐ»Ð¾Ñ‚Ð°
    const slotIndex = timeSlots.findIndex(slot => slot.id === slotId);
    if (slotIndex !== -1) {
      timeSlots[slotIndex].isBooked = true;
    }
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑƒÑ€Ð¾Ðº
    lessons.push(lesson);
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ñ„Ð°Ð¹Ð»
    saveServerData();
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²ÑÐµÐ¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼
    io.emit('slotBooked', data);
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚Ð¼ÐµÐ½Ñ‹ Ð±Ñ€Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  socket.on('cancelSlot', (data) => {
    console.log('Slot cancelled:', data);
    const { slotId, lessonId } = data;
    
    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÑÐ»Ð¾Ñ‚Ð°
    const slotIndex = timeSlots.findIndex(slot => slot.id === slotId);
    if (slotIndex !== -1) {
      timeSlots[slotIndex].isBooked = false;
    }
    
    // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑƒÑ€Ð¾Ðº
    const lessonIndex = lessons.findIndex(lesson => lesson.id === lessonId);
    if (lessonIndex !== -1) {
      lessons.splice(lessonIndex, 1);
    }
    
    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ñ„Ð°Ð¹Ð»
    saveServerData();
    
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²ÑÐµÐ¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼
    io.emit('slotCancelled', data);
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÐ»Ð¾Ñ‚Ð°
  socket.on('deleteSlot', (data) => {
    const { slotId } = data;
    if (slotId) {
      timeSlots = timeSlots.filter(slot => slot.id !== slotId);
      saveServerData(); // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ñ„Ð°Ð¹Ð»
      io.emit('slotDeleted', { slotId });
      console.log('Slot deleted:', slotId);
    }
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²Ð¸Ð´ÐµÐ¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
  const rooms = {};

  socket.on('video-join', (data) => {
    const { roomId, userName, userRole } = data;
    if (!rooms[roomId]) rooms[roomId] = new Set();
    rooms[roomId].add(socket.id);
    socket.join(roomId);
    console.log(`[Video] ${userName} (${userRole}) joined video room ${roomId}`);
    
    socket.emit('video-connected', { roomId });
    socket.to(roomId).emit('video-user-joined', { userName, userRole });
  });

  socket.on('video-offer', (data) => {
    const { roomId, offer } = data;
    console.log(`[Video] Forwarding offer in room ${roomId}`);
    socket.to(roomId).emit('video-offer', { offer });
  });

  socket.on('video-answer', (data) => {
    const { roomId, answer } = data;
    console.log(`[Video] Forwarding answer in room ${roomId}`);
    socket.to(roomId).emit('video-answer', { answer });
  });

  socket.on('video-ice-candidate', (data) => {
    const { roomId, candidate } = data;
    console.log(`[Video] Forwarding ICE candidate in room ${roomId}`);
    socket.to(roomId).emit('video-ice-candidate', { candidate });
  });

  socket.on('video-leave', (data) => {
    const { roomId, userName } = data;
    if (rooms[roomId]) {
      rooms[roomId].delete(socket.id);
      if (rooms[roomId].size === 0) delete rooms[roomId];
    }
    socket.leave(roomId);
    socket.to(roomId).emit('video-user-left', { userName });
    console.log(`[Video] ${userName} left video room ${roomId}`);
  });

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ñ‡Ð°Ñ‚Ðµ
  socket.on('sendMessage', (data) => {
    console.log('Message received:', data);
    io.emit('receiveMessage', data);
  });

  socket.on('disconnect', () => {
    console.log('Client disconnected:', socket.id);
  });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 10000;
const HOST = process.env.HOST || '0.0.0.0';

server.listen(PORT, HOST, () => {
  console.log(`ðŸš€ Static server running on port ${PORT}`);
  console.log(`ðŸ“¡ Server accessible at:`);
  console.log(`  - Local: http://localhost:${PORT}`);
  console.log(`  - Network: http://${HOST}:${PORT}`);
  console.log(`  - Environment: ${process.env.NODE_ENV || 'development'}`);
  console.log(`  - CORS enabled for: ${allowedOrigins.join(', ')}`);
}); 